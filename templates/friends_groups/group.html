{% extends "base.html" %}

{% block content %}
    <section>
        <h2>{{ group.group_name }}</h2>
        <p>{{ group.description }}</p>

        <!-- Create Post Form -->
        <h3>Share Your Thoughts</h3>
        <form id="post-form" method="post" action="{{ url_for('create_group_post', group_id=group.group_id) }}">
            <input type="text" id="post-content" name="post_content" placeholder="Share your thoughts">
            <button type="submit">Post</button>
        </form>

        <!-- Discussion Forum -->
        <div id="discussion">
            {% for post in posts %}
                <div class="post">
                    <p>{{ post.user.username }} says:</p>
                    <p>{{ post.post_content }}</p>
                    <p>Posted on: {{ post.timestamp }}</p>
                    {% if post.user_id == g.user.user_id %}
                        <form method="post" action="{{ url_for('delete_post', post_id=post.id) }}">
                            <button type="submit" class="delete-post-button">Delete</button>
                        </form>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <!-- Coping Solutions / Resources -->
        <h2>Coping Solutions / Resources</h2>
        <ul>
            <li><a href="#">Res</a></li>
            <li><a href="#">Res</a></li>
            <!-- Add more resource links here -->
        </ul>

        <!-- Button to See Group Members -->
        <button id="seeGroupMembersButton" data-group-id="{{ group.group_id }}">See Group Members</button>


        <!-- Group Members List -->
        <ul id="groupMembers" style="display: none;"></ul>


    </section>
    <a href="{{ url_for('friends_groups') }}">Back to Groups & Friends</a>
    <a href="{{ url_for('homepage') }}">Back to Home</a>
</div>



<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Function to add a post to the discussion forum
        function addPostToDiscussion(username, content, timestamp, post_id) {
            const post = document.createElement("div");
            post.className = "post";
            post.innerHTML = `<p>${username} says:</p><p>${content}</p><p>Posted on ${timestamp}</p>`;
    
            if (g.user && post_id === g.user.user_id) {
                const deleteForm = document.createElement("form");
                deleteForm.method = "post";
                deleteForm.action = `/delete_post/${post_id}`;
    
                const deleteButton = document.createElement("button");
                deleteButton.type = "submit";
                deleteButton.className = "delete-post-button";
                deleteButton.textContent = "Delete";
    
                deleteForm.appendChild(deleteButton);
    
                post.appendChild(deleteForm);
                post.innerHTML += '<p>My Post</p>';
            }
    
            document.getElementById("discussion").appendChild(post);
        }
    
        // Function to create a new post
        async function createNewPost(content) {
            try {
                const groupId = window.location.pathname.match(/\/group\/(\d+)/);
                if (groupId) {
                    const response = await fetch(`/create_group_post/${groupId[1]}`, {
                        method: "POST",
                        body: new URLSearchParams({ post_content: content }),
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                    });
    
                    if (response.ok) {
                        const postData = await response.json();
                        addPostToDiscussion(postData.username, postData.content, postData.timestamp, postData.post_id);
                        document.getElementById("post-content").value = "";
                    }
                } else {
                    console.error("Group ID not found in the URL.");
                }
            } catch (error) {
                console.error("Error creating a new post:", error);
            }
        }
    
        // Check if local storage has posts and display them
        const storedPosts = JSON.parse(localStorage.getItem("discussionPosts")) || [];
        storedPosts.forEach((post) => {
            addPostToDiscussion(post.username, post.content, post.timestamp, post.userId);
        });
    
        document.getElementById("post-form").addEventListener("submit", async function (event) {
            event.preventDefault();
            const content = document.getElementById("post-content").value;
            if (content) {
                await createNewPost(content);
            }
        });
        
        // JavaScript code to fetch and display group members
        const seeGroupMembersButton = document.getElementById("seeGroupMembersButton");
    
        seeGroupMembersButton.addEventListener("click", async () => {
            fetchAndDisplayGroupMembers();
        });
    });

  // JavaScript code to fetch and display group members
document.addEventListener('DOMContentLoaded', function () {
    const seeGroupMembersButton = document.getElementById("seeGroupMembersButton");
    
    // Function to fetch and display group members
    async function fetchAndDisplayGroupMembers() {
        const groupMembers = document.getElementById("groupMembers");
        const groupId = seeGroupMembersButton.getAttribute("data-group-id"); // Get the group_id from the button's data attribute

        // Make a request to the server to get group members
        try {
            const response = await fetch(`/get_group_members/${groupId}`, {
                method: 'GET',
            });

            if (response.ok) {
                const data = await response.json();

                if (data.length > 0) {
                    groupMembers.innerHTML = '<h3>Group Members:</h3>';
                    const ul = document.createElement("ul");

                    data.forEach(member => {
                        const li = document.createElement("li");
                        li.textContent = member.username;
                        ul.appendChild(li);
                    });

                    groupMembers.appendChild(ul);
                } else {
                    groupMembers.innerHTML = '<p>No group members found.</p>';
                }

                groupMembers.style.display = "block";
            } else {
                console.error('Failed to fetch group members:', response.statusText);
                groupMembers.innerHTML = '<p>Failed to fetch group members.</p>';
                groupMembers.style.display = "block";
            }
        } catch (error) {
            console.error('Error fetching group members:', error);
            groupMembers.innerHTML = '<p>Failed to fetch group members.</p>';
            groupMembers.style.display = "block";
        }
    }

    seeGroupMembersButton.addEventListener("click", () => {
        fetchAndDisplayGroupMembers();
    });
});

</script>
{% endblock %}
